import { useEffect, useState } from "react";
import { useNotifications } from "../contexts/NotificationContext";
import { useNavigate } from "react-router-dom";
import type { Notificacion, NotificacionTipo } from "../types";
import { formatDistanceToNow } from "date-fns";
import { es } from "date-fns/locale";
import PostModal from "../components/social/PostModal";
import CommentModal from "../components/social/CommentModal";
import SongCommentModal from "../components/musica/SongCommentModal";
import { usePlayer } from "../contexts/PlayerContext";
import { musicService } from "../services/music.service";
import { albumService } from "../services/album.service";
import { LoadingSpinner, EmptyState, Button } from "../components/common";

/**
 * Notifications - P√°gina de notificaciones
 *
 * Muestra todas las notificaciones del usuario (nuevas canciones, seguidores, comentarios, etc.)
 */

export default function Notifications() {
  const {
    notificaciones,
    isLoading,
    markAsRead,
    markAllAsRead,
    deleteNotification,
    fetchNotifications,
  } = useNotifications();
  const navigate = useNavigate();
  const { playSong, playQueue, clearQueue } = usePlayer();

  const [filter, setFilter] = useState<
    "todas" | "musica" | "social" | "sistema"
  >("todas");

  const [selectedPostId, setSelectedPostId] = useState<string | null>(null);
  const [showPostModal, setShowPostModal] = useState(false);
  const [highlightCommentId, setHighlightCommentId] = useState<
    string | undefined
  >(undefined);
  const [autoOpenComments, setAutoOpenComments] = useState(false);
  const [showCommentModal, setShowCommentModal] = useState(false);
  const [selectedCommentId, setSelectedCommentId] = useState<string | null>(
    null
  );
  const [showSongCommentModal, setShowSongCommentModal] = useState(false);
  const [selectedSongId, setSelectedSongId] = useState<string | null>(null);

  // Recargar notificaciones cuando se monta el componente
  useEffect(() => {
    fetchNotifications();
  }, []);

  // Filtrar notificaciones seg√∫n el filtro activo
  const filteredNotifications = notificaciones.filter((notif) => {
    if (filter === "todas") return true;
    if (filter === "musica")
      return [
        "nueva_cancion_artista",
        "nuevo_album_artista",
        "nueva_playlist_artista",
      ].includes(notif.tipo);
    if (filter === "social")
      return [
        "nuevo_seguidor",
        "solicitud_amistad",
        "amistad_aceptada",
        "nuevo_post",
        "like_post",
        "comentario_post",
        "repost",
      ].includes(notif.tipo);
    if (filter === "sistema") return notif.tipo === "sistema";
    return true;
  });

  const handleNotificationClick = async (notif: Notificacion) => {
    // Marcar como le√≠da
    if (!notif.leida) {
      await markAsRead(notif._id);
    }

    // Para notificaciones de seguidor y amistad, navegar directamente al perfil del usuario origen
    if (
      (notif.tipo === "nuevo_seguidor" ||
        notif.tipo === "solicitud_amistad" ||
        notif.tipo === "amistad_aceptada") &&
      notif.usuarioOrigen &&
      typeof notif.usuarioOrigen === "object"
    ) {
      navigate(`/perfil/${notif.usuarioOrigen.nick}`);
      return;
    }

    // Navegar seg√∫n el tipo de recurso
    if (notif.recurso) {
      switch (notif.recurso.tipo) {
        case "song":
        case "cancion":
          // Si es comentario en canci√≥n con comentarioId, abrir SongCommentModal
          if (notif.recurso.comentarioId) {
            setSelectedSongId(notif.recurso.id);
            setSelectedCommentId(notif.recurso.comentarioId);
            setShowSongCommentModal(true);
            return; // Evitar navegaci√≥n adicional
          } else {
            // Cargar la canci√≥n y reproducirla inmediatamente
            try {
              console.log(
                "üéµ Intentando cargar canci√≥n con ID:",
                notif.recurso.id
              );
              const cancion = await musicService.getSongById(notif.recurso.id);
              console.log("‚úÖ Canci√≥n cargada:", cancion);
              console.log("üîç Es single?:", cancion.esSingle);

              // Si es single, usar contexto de single
              if (cancion.esSingle) {
                const contexto = {
                  type: "album" as const,
                  id: "single",
                  name: `Single: ${cancion.titulo}`,
                };
                console.log("üìÅ Reproduciendo con contexto:", contexto);
                playQueue([cancion], 0, contexto);
              } else {
                // Si tiene √°lbum, reproducir solo esta canci√≥n sin contexto especial
                console.log("üìÅ Reproduciendo sin contexto (tiene √°lbum)");
                playQueue([cancion], 0);
              }
            } catch (error: any) {
              console.error("‚ùå Error al cargar la canci√≥n:", error);
              console.error("‚ùå ID de la canci√≥n:", notif.recurso.id);

              // Mostrar mensaje al usuario
              alert(
                error.response?.status === 404
                  ? "Esta canci√≥n ya no est√° disponible o fue eliminada"
                  : "No se pudo cargar la canci√≥n. Intenta m√°s tarde."
              );
            }
          }
          return; // Evitar navegaci√≥n adicional
        case "album":
          // Cargar el √°lbum y agregar todas sus canciones a la cola
          try {
            const album = await albumService.obtenerAlbum(notif.recurso.id);
            if (album.canciones && album.canciones.length > 0) {
              // Reproducir todas las canciones del √°lbum
              playQueue(album.canciones, 0, {
                type: "album",
                id: album._id,
                name: album.titulo,
              });
            }
          } catch (error: any) {
            console.error("Error al cargar el √°lbum:", error);
            alert(
              error.response?.status === 404
                ? "Este √°lbum fue retirado de la p√°gina"
                : "No se pudo cargar el √°lbum. Intenta m√°s tarde."
            );
          }
          return; // Evitar navegaci√≥n adicional
        case "playlist":
          // Cargar la playlist y agregar todas sus canciones a la cola
          try {
            const playlist = await musicService.getPlaylistById(
              notif.recurso.id
            );
            if (playlist.canciones && playlist.canciones.length > 0) {
              // Reproducir todas las canciones de la playlist
              playQueue(playlist.canciones, 0, {
                type: "playlist",
                id: playlist._id,
                name: playlist.titulo,
              });
            }
          } catch (error: any) {
            console.error("Error al cargar la playlist:", error);
            alert(
              error.response?.status === 404
                ? "Esta playlist fue retirada de la p√°gina"
                : "No se pudo cargar la playlist. Intenta m√°s tarde."
            );
          }
          return; // Evitar navegaci√≥n adicional
        case "usuario":
          navigate(`/perfil/${notif.recurso.id}`);
          return;
        case "post":
          // Abrir PostModal con comentarios
          setSelectedPostId(notif.recurso.id);

          if (notif.tipo === "like_post" || notif.tipo === "repost") {
            setAutoOpenComments(true);
          } else {
            setAutoOpenComments(false);
          }
          setHighlightCommentId(undefined);
          setShowPostModal(true);
          return;
        case "comment":
        case "comentario":
          // Navegar al perfil donde est√° el comentario
          if (typeof notif.usuarioOrigen === "object" && notif.usuarioOrigen) {
            navigate(`/perfil/${notif.usuarioOrigen.nick}`);
          }
          return;
      }
    } else if (notif.usuarioOrigen && typeof notif.usuarioOrigen === "object") {
      // Si no hay recurso espec√≠fico, ir al perfil del usuario origen
      navigate(`/perfil/${notif.usuarioOrigen.nick}`);
    }
  };

  const getFormattedMessage = (notif: Notificacion) => {
    // SIEMPRE usar el mensaje de la base de datos que ya incluye toda la informaci√≥n
    return notif.mensaje;
  };

  const getNotificationIcon = (notif: Notificacion) => {
    // Si hay un usuario origen, mostrar su foto (o la por defecto)
    if (notif.usuarioOrigen && typeof notif.usuarioOrigen === "object") {
      return (
        <img
          src={
            notif.usuarioOrigen.avatarUrl &&
            notif.usuarioOrigen.avatarUrl.trim() !== ""
              ? notif.usuarioOrigen.avatarUrl
              : "/avatar.png"
          }
          alt={notif.usuarioOrigen.nombreArtistico || notif.usuarioOrigen.nick}
          className="w-12 h-12 rounded-full shrink-0 object-cover"
          onError={(e) => {
            e.currentTarget.src = "/avatar.png";
          }}
        />
      );
    }

    // Sino, mostrar icono seg√∫n el tipo
    const tipo = notif.tipo;
    switch (tipo) {
      case "nueva_cancion_artista":
      case "nuevo_album_artista":
        return (
          <div className="w-12 h-12 bg-linear-to-br from-purple-500 to-pink-500 rounded-full shrink-0 flex items-center justify-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            >
              <path d="M9 18V5l12-2v13"></path>
              <circle cx="6" cy="18" r="3"></circle>
              <circle cx="18" cy="16" r="3"></circle>
            </svg>
          </div>
        );
      case "nueva_playlist_artista":
        return (
          <div className="w-12 h-12 bg-linear-to-br from-green-500 to-emerald-500 rounded-full shrink-0 flex items-center justify-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            >
              <path d="M21 15V6"></path>
              <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"></path>
              <path d="M12 12H3"></path>
              <path d="M16 6H3"></path>
              <path d="M12 18H3"></path>
            </svg>
          </div>
        );
      case "sistema":
        return (
          <div className="w-12 h-12 bg-linear-to-br from-orange-500 to-yellow-500 rounded-full shrink-0 flex items-center justify-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            >
              <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
              <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
              <path d="M4 22h16"></path>
              <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
              <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
              <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
            </svg>
          </div>
        );
      case "nuevo_seguidor":
      case "solicitud_amistad":
      case "amistad_aceptada":
        return (
          <div className="w-12 h-12 bg-linear-to-br from-blue-500 to-cyan-500 rounded-full shrink-0 flex items-center justify-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            >
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
        );
      case "comentario_en_perfil":
      case "respuesta_comentario":
      case "like_comentario":
        return (
          <div className="w-12 h-12 bg-linear-to-br from-pink-500 to-rose-500 rounded-full shrink-0 flex items-center justify-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            >
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
        );
      default:
        return (
          <div className="w-12 h-12 bg-neutral-700 rounded-full shrink-0"></div>
        );
    }
  };

  return (
    <div className="min-h-screen bg-linear-to-b from-neutral-950 via-neutral-900 to-neutral-950 p-6">
      <div className="max-w-4xl mx-auto">
        {/* Header con gradiente */}
        <div className="mb-8 relative">
          <div className="absolute inset-0 bg-linear-to-r from-orange-500/10 via-pink-500/10 to-purple-500/10 blur-3xl" />
          <div className="relative">
            <h1 className="text-5xl font-black mb-3 bg-linear-to-r from-orange-400 via-pink-500 to-purple-500 bg-clip-text text-transparent">
              Notificaciones
            </h1>
            <p className="text-neutral-400 text-lg">
              Mantente al d√≠a con tu actividad
            </p>
          </div>
        </div>

        {/* Filtros mejorados */}
        <div className="flex flex-wrap items-center gap-3 mb-6">
          <button
            onClick={() => setFilter("todas")}
            className={`px-6 py-2.5 rounded-full text-sm font-bold transition-all duration-300 ${
              filter === "todas"
                ? "bg-gradient-to-r from-orange-500 to-pink-500 text-white shadow-lg shadow-orange-500/30"
                : "bg-neutral-800/50 backdrop-blur-sm text-neutral-300 hover:bg-neutral-700/50"
            }`}
          >
            üîî Todas
          </button>
          <button
            onClick={() => setFilter("musica")}
            className={`px-6 py-2.5 rounded-full text-sm font-bold transition-all duration-300 ${
              filter === "musica"
                ? "bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg shadow-purple-500/30"
                : "bg-neutral-800/50 backdrop-blur-sm text-neutral-300 hover:bg-neutral-700/50"
            }`}
          >
            üéµ M√∫sica
          </button>
          <button
            onClick={() => setFilter("social")}
            className={`px-6 py-2.5 rounded-full text-sm font-bold transition-all duration-300 ${
              filter === "social"
                ? "bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/30"
                : "bg-neutral-800/50 backdrop-blur-sm text-neutral-300 hover:bg-neutral-700/50"
            }`}
          >
            üë• Social
          </button>
          <button
            onClick={() => setFilter("sistema")}
            className={`px-6 py-2.5 rounded-full text-sm font-bold transition-all duration-300 ${
              filter === "sistema"
                ? "bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-lg shadow-yellow-500/30"
                : "bg-neutral-800/50 backdrop-blur-sm text-neutral-300 hover:bg-neutral-700/50"
            }`}
          >
            ‚öôÔ∏è Sistema
          </button>
        </div>

        {/* Marcar todas como le√≠das - mejorado */}
        {notificaciones.some((n) => !n.leida) && (
          <div className="flex justify-end mb-6">
            <button
              onClick={markAllAsRead}
              className="px-4 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-sm font-semibold transition-all duration-300 flex items-center gap-2 backdrop-blur-sm border border-green-500/30"
            >
              ‚úì Marcar todas como le√≠das
            </button>
          </div>
        )}

        {/* Lista de notificaciones */}
        {isLoading ? (
          <LoadingSpinner />
        ) : filteredNotifications.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-20">
            <div className="mb-6 flex items-center justify-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="64"
                height="64"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className="text-neutral-600"
              >
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
              </svg>
            </div>
            <h3 className="text-xl font-bold text-neutral-300 mb-2">
              No hay notificaciones
            </h3>
            <p className="text-neutral-500 text-center">
              {filter === "todas"
                ? "Estar√°s al d√≠a con tu actividad"
                : `No hay notificaciones de ${filter}`}
            </p>
          </div>
        ) : (
          <div className="space-y-3">
            {filteredNotifications.map((notif, index) => {
              // Determinar si la notificaci√≥n lleva al perfil del usuario
              const isProfileNotification =
                notif.tipo === "nuevo_seguidor" ||
                notif.tipo === "solicitud_amistad" ||
                notif.tipo === "amistad_aceptada";

              return (
                <div
                  key={notif._id}
                  onClick={() => handleNotificationClick(notif)}
                  style={{ animationDelay: `${index * 50}ms` }}
                  className={`bg-linear-to-r from-neutral-900/80 to-neutral-800/60 backdrop-blur-sm p-5 rounded-xl hover:from-neutral-800/90 hover:to-neutral-700/70 transition-all duration-300 cursor-pointer relative group border ${
                    !notif.leida
                      ? "border-l-4 border-orange-500 shadow-lg shadow-orange-500/20 animate-fade-in"
                      : "border-neutral-800/50 hover:border-neutral-700"
                  } ${
                    isProfileNotification
                      ? "hover:border-blue-500/50 hover:shadow-lg hover:shadow-blue-500/10"
                      : ""
                  }`}
                >
                  <div className="flex items-start gap-4">
                    <div className="relative">
                      {getNotificationIcon(notif)}
                      {!notif.leida && (
                        <div className="absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full border-2 border-neutral-900 animate-pulse" />
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p
                        className={`${
                          !notif.leida
                            ? "font-bold text-white"
                            : "font-medium text-neutral-200"
                        } mb-1.5 leading-relaxed`}
                      >
                        {getFormattedMessage(notif)}
                      </p>
                      <span className="text-xs text-neutral-500 font-medium">
                        {formatDistanceToNow(new Date(notif.createdAt), {
                          addSuffix: true,
                          locale: es,
                        })}
                      </span>
                    </div>

                    {/* Bot√≥n eliminar mejorado */}
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteNotification(notif._id);
                      }}
                      className="opacity-0 group-hover:opacity-100 transition-all duration-300 p-2.5 hover:bg-red-500/20 hover:text-red-400 rounded-lg text-neutral-400"
                      title="Eliminar notificaci√≥n"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                      >
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* Modal de Post */}
        {selectedPostId && (
          <PostModal
            postId={selectedPostId}
            isOpen={showPostModal}
            onClose={() => {
              setShowPostModal(false);
              setSelectedPostId(null);
              setHighlightCommentId(undefined);
              setAutoOpenComments(false);
            }}
            highlightCommentId={highlightCommentId}
            autoOpenComments={autoOpenComments}
          />
        )}

        {/* Modal de Comentario Espec√≠fico */}
        {selectedPostId && selectedCommentId && (
          <CommentModal
            postId={selectedPostId}
            comentarioId={selectedCommentId}
            isOpen={showCommentModal}
            onClose={() => {
              setShowCommentModal(false);
              setSelectedPostId(null);
              setSelectedCommentId(null);
            }}
          />
        )}

        {/* Modal de Comentario en Canci√≥n */}
        {selectedSongId && selectedCommentId && (
          <SongCommentModal
            songId={selectedSongId}
            comentarioId={selectedCommentId}
            isOpen={showSongCommentModal}
            onClose={() => {
              setShowSongCommentModal(false);
              setSelectedSongId(null);
              setSelectedCommentId(null);
            }}
          />
        )}
      </div>
    </div>
  );
}
