// models/Comentario.js
import { Schema, model } from "mongoose";
// Si usas CommonJS:
// const { Schema, model } = require("mongoose");

const respuestaSchema = new Schema(
  {
    autor: {
      type: Schema.Types.ObjectId,
      ref: "Usuario",
      required: true,
    },
    texto: {
      type: String,
      required: true,
      trim: true,
      maxlength: 300,
    },
    estaEditado: {
      type: Boolean,
      default: false,
    },
  },
  {
    timestamps: {
      createdAt: true,
      updatedAt: true,
    },
    _id: true,
  }
);

const comentarioSchema = new Schema(
  {
    // Quién escribe el comentario
    autor: {
      type: Schema.Types.ObjectId,
      ref: "Usuario",
      required: true,
    },

    // Perfil (usuario/artista) donde se deja el comentario (opcional)
    perfilDestino: {
      type: Schema.Types.ObjectId,
      ref: "Usuario",
    },

    // Canción donde se deja el comentario (opcional)
    cancionDestino: {
      type: Schema.Types.ObjectId,
      ref: "Cancion",
    },

    // Texto principal del comentario
    texto: {
      type: String,
      required: true,
      trim: true,
      minlength: 1,
      maxlength: 500,
    },

    // Opcional: valoración tipo estrellas (1–5)

    // Respuestas en hilo
    respuestas: [respuestaSchema],

    // Usuarios que han dado “like” al comentario
    likes: [
      {
        type: Schema.Types.ObjectId,
        ref: "Usuario",
      },
    ],

    // Borrado lógico
    estaEliminado: {
      type: Boolean,
      default: false,
    },
  },
  {
    timestamps: true, // createdAt, updatedAt
  }
);

// Índices útiles: listar comentarios de un perfil o canción por fecha
comentarioSchema.index({ perfilDestino: 1, createdAt: -1 });
comentarioSchema.index({ cancionDestino: 1, createdAt: -1 });

export const Comentario = model("Comentario", comentarioSchema);
// CommonJS: module.exports = model("Comentario", comentarioSchema);
